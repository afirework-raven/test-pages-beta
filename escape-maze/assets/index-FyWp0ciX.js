(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function i(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(s){if(s.ep)return;s.ep=!0;const r=i(s);fetch(s.href,r)}})();const w={up:{x:0,y:-1},down:{x:0,y:1},left:{x:-1,y:0},right:{x:1,y:0}};function S(d,t,i){return i>=0&&i<d.length&&t>=0&&t<d[i].length}function x(d,t,i){return S(d,t,i)?d[i][t]!=="wall":!1}const P=d=>{const t=[...d];for(let i=t.length-1;i>0;i-=1){const e=Math.floor(Math.random()*(i+1));[t[i],t[e]]=[t[e],t[i]]}return t};class C{canvas;ctx;grid=[];rows=21;cols=21;tileWidth=0;tileHeight=0;offsetX=0;offsetY=0;player={row:1,col:1};animatedPlayer={current:{row:1,col:1},target:{row:1,col:1},progress:1};doorPosition={row:19,col:19};keyPosition=null;keyCollected=!1;doorSpawned=!1;visibility=[];state="ready";callbacks;animationFrameId=null;lastFrameTime=0;ANIMATION_DURATION_MS=150;TARGET_TILE_SIZE=40;currentDirection=null;nextDirection=null;facingDirection="right";elapsedTime=0;constructor(t,i={}){const e=t.getContext("2d");if(!e)throw new Error("Canvas context unavailable");this.canvas=t,this.ctx=e,this.callbacks=i}reset(){this.grid=this.generateMaze(this.rows,this.cols),this.player={row:1,col:1},this.animatedPlayer={current:{row:1,col:1},target:{row:1,col:1},progress:1},this.currentDirection=null,this.nextDirection=null,this.facingDirection="right",this.elapsedTime=0,this.keyCollected=!1,this.doorSpawned=!1,this.doorPosition={row:this.rows-2,col:this.cols-2},this.grid[this.doorPosition.row][this.doorPosition.col]="path",this.keyPosition=this.placeKey(),this.updateVisibility(),this.state="playing",this.callbacks.onStateChange?.(this.state),this.startAnimationLoop()}resize(t,i){const e=window.devicePixelRatio||1;this.canvas.style.width=`${t}px`,this.canvas.style.height=`${i}px`,this.canvas.width=t*e,this.canvas.height=i*e,this.ctx.setTransform(e,0,0,e,0,0);const s=window.matchMedia("(max-width: 768px)").matches;let r=0,o=0,a=0;if(s){const n=Math.max(30,Math.floor(t/this.TARGET_TILE_SIZE));r=n%2===0?n+1:n,a=t/r;const c=Math.floor(i/a);let h=Math.max(5,c);h%2===0&&(h=(h+1)*a<=i?h+1:Math.max(5,h-1)),o=h}else{const l=Math.floor(t/this.TARGET_TILE_SIZE),n=Math.floor(i/this.TARGET_TILE_SIZE);r=Math.max(5,l%2===0?l-1:l),o=Math.max(5,n%2===0?n-1:n),a=Math.min(t/r,i/o)}(r!==this.cols||o!==this.rows||this.grid.length===0)&&(this.cols=r,this.rows=o,this.reset()),this.tileWidth=a,this.tileHeight=a,this.offsetX=(t-a*this.cols)/2,this.offsetY=(i-a*this.rows)/2,this.render()}move(t){this.state==="playing"&&(this.nextDirection=t)}generateMaze(t,i){const e=Array.from({length:t},()=>Array(i).fill("wall")),s=(o,a)=>o>0&&a>0&&o<t-1&&a<i-1,r=(o,a)=>{e[o][a]="path",P([[0,2],[0,-2],[2,0],[-2,0]]).forEach(([n,c])=>{const h=o+n,f=a+c;!s(h,f)||e[h][f]==="path"||(e[o+n/2][a+c/2]="path",r(h,f))})};return r(1,1),this.createBraidMaze(e,t,i),e}createBraidMaze(t,i,e){const s=[];for(let o=1;o<i-1;o+=1)for(let a=1;a<e-1;a+=1)t[o][a]==="path"&&[[o-1,a],[o+1,a],[o,a-1],[o,a+1]].filter(([n,c])=>t[n][c]==="path").length===1&&s.push({row:o,col:a});P(s).slice(0,Math.floor(s.length*.3)).forEach(({row:o,col:a})=>{const l=[];if([{dr:-2,dc:0},{dr:2,dc:0},{dr:0,dc:-2},{dr:0,dc:2}].forEach(({dr:n,dc:c})=>{const h=o+n,f=a+c,p=o+n/2,u=a+c/2;h>0&&h<i-1&&f>0&&f<e-1&&t[h][f]==="path"&&t[p][u]==="wall"&&l.push({row:h,col:f,wallRow:p,wallCol:u})}),l.length>0){const n=l[Math.floor(Math.random()*l.length)];t[n.wallRow][n.wallCol]="path"}})}placeKey(){const t=[];for(let e=1;e<this.rows-1;e+=1)for(let s=1;s<this.cols-1;s+=1)if(this.grid[e][s]==="path"){if(e===this.player.row&&s===this.player.col||e===this.doorPosition.row&&s===this.doorPosition.col)continue;t.push({row:e,col:s})}const i=t.length>0?t[Math.floor(Math.random()*t.length)]:{row:this.player.row,col:this.player.col};return this.grid[i.row][i.col]="key",i}collectKey(){this.keyCollected||(this.keyCollected=!0,this.keyPosition&&(this.grid[this.keyPosition.row][this.keyPosition.col]="path"),this.keyPosition=null,this.spawnDoor())}spawnDoor(){this.doorSpawned||(this.doorSpawned=!0,this.grid[this.doorPosition.row][this.doorPosition.col]="door")}updateVisibility(){this.visibility=Array.from({length:this.rows},()=>Array(this.cols).fill(!1));for(let t=0;t<this.rows;t+=1)for(let i=0;i<this.cols;i+=1)this.hasLineOfSight(t,i)&&(this.visibility[t][i]=!0)}hasLineOfSight(t,i){let e=this.player.col,s=this.player.row;const r=i,o=t,a=Math.abs(r-e),l=Math.abs(o-s),n=e<r?1:-1,c=s<o?1:-1;let h=a-l;for(;!(e===r&&s===o);){if(!(e===this.player.col&&s===this.player.row)&&this.grid[s][e]==="wall")return!1;const f=2*h;f>-l&&(h-=l,e+=n),f<a&&(h+=a,s+=c)}return!0}render(){if(!(!this.tileWidth||!this.tileHeight)){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.fillStyle="#020617",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore();for(let t=0;t<this.rows;t+=1)for(let i=0;i<this.cols;i+=1){const e=this.grid[t][i];if(!(this.visibility[t]?.[i]??!1)){this.drawCell(i,t,"#020617");continue}e==="wall"?this.drawCell(i,t,"#0f172a"):e==="path"?this.drawCell(i,t,"#1e293b"):e==="key"?this.drawCell(i,t,"#facc15"):e==="door"?this.drawDoor(i,t):e==="exit"&&this.drawCell(i,t,"#38bdf8")}this.drawPlayer()}}drawCell(t,i,e){this.ctx.fillStyle=e,this.ctx.fillRect(this.offsetX+t*this.tileWidth,this.offsetY+i*this.tileHeight,this.tileWidth,this.tileHeight)}drawDoor(t,i){const e=this.offsetX+t*this.tileWidth,s=this.offsetY+i*this.tileHeight;this.ctx.fillStyle="#1e293b",this.ctx.fillRect(e,s,this.tileWidth,this.tileHeight);const r=Math.min(this.tileWidth,this.tileHeight)*.1,o=e+r,a=s+r,l=this.tileWidth-r*2,n=this.tileHeight-r*2;this.ctx.fillStyle="#92400e",this.ctx.fillRect(o,a,l,n),this.ctx.strokeStyle="#f59e0b",this.ctx.lineWidth=Math.max(1,r*.4),this.ctx.strokeRect(o,a,l,n);const c=r*.6;this.ctx.strokeStyle="#fbbf24",this.ctx.lineWidth=Math.max(1,r*.3),this.ctx.strokeRect(o+c,a+c,l-c*2,n-c*2);const h=Math.min(this.tileWidth,this.tileHeight)*.08,f=o+l*.75,p=a+n*.55;this.ctx.fillStyle="#fde047",this.ctx.beginPath(),this.ctx.arc(f,p,h,0,Math.PI*2),this.ctx.fill()}drawPlayer(){const t=this.animatedPlayer.current.row+(this.animatedPlayer.target.row-this.animatedPlayer.current.row)*this.animatedPlayer.progress,i=this.animatedPlayer.current.col+(this.animatedPlayer.target.col-this.animatedPlayer.current.col)*this.animatedPlayer.progress,e=this.offsetX+i*this.tileWidth+this.tileWidth/2,s=this.offsetY+t*this.tileHeight+this.tileHeight/2,r=Math.min(this.tileWidth,this.tileHeight)*.35,o=this.getFacingAngle(),l=.25+(Math.sin(this.elapsedTime*.012)+1)/2*.2;this.ctx.fillStyle="#fbbf24",this.ctx.beginPath(),this.ctx.moveTo(e,s),this.ctx.arc(e,s,r,o+l,o-l,!0),this.ctx.closePath(),this.ctx.fill();const n=Math.cos(o),c=Math.sin(o),h=-c,f=n,p=e+n*r*.15+h*r*.5,u=s+c*r*.15+f*r*.5,T=r*.1;this.ctx.fillStyle="#0f172a",this.ctx.beginPath(),this.ctx.arc(p,u,T,0,Math.PI*2),this.ctx.fill()}pickDirection(){let t=null;if(this.nextDirection){const i=w[this.nextDirection];x(this.grid,this.player.col+i.x,this.player.row+i.y)&&(t=this.nextDirection,this.currentDirection=this.nextDirection,this.nextDirection=null)}if(!t&&this.currentDirection){const i=w[this.currentDirection];x(this.grid,this.player.col+i.x,this.player.row+i.y)?t=this.currentDirection:this.currentDirection=null}return t}getFacingAngle(){switch(this.facingDirection){case"up":return-Math.PI/2;case"down":return Math.PI/2;case"left":return Math.PI;default:return 0}}startMove(t){const i=w[t],e=this.player.col+i.x,s=this.player.row+i.y;this.facingDirection=t,this.player={row:s,col:e},this.updateVisibility(),this.animatedPlayer={current:{row:this.animatedPlayer.target.row,col:this.animatedPlayer.target.col},target:{row:s,col:e},progress:0},!this.keyCollected&&this.keyPosition&&s===this.keyPosition.row&&e===this.keyPosition.col&&this.collectKey(),this.doorSpawned&&s===this.doorPosition.row&&e===this.doorPosition.col&&(this.state="escaped",this.callbacks.onStateChange?.(this.state))}startAnimationLoop(){this.animationFrameId!==null&&cancelAnimationFrame(this.animationFrameId),this.lastFrameTime=performance.now(),this.animate(this.lastFrameTime)}animate=t=>{const i=t-this.lastFrameTime;this.lastFrameTime=t,this.elapsedTime+=i;const e=i/this.ANIMATION_DURATION_MS;if(this.state==="playing"&&this.animatedPlayer.progress>=1){const s=this.pickDirection();s&&this.startMove(s)}if(this.animatedPlayer.progress<1){let s=this.animatedPlayer.progress+e,r=0;for(;s>=1&&this.state==="playing"&&r<4&&(s-=1,this.animatedPlayer.current={...this.animatedPlayer.target},this.animatedPlayer.progress=1,this.state==="playing");){const o=this.pickDirection();if(!o){s=1;break}this.startMove(o),r+=1}this.animatedPlayer.progress=Math.min(1,s)}this.render(),this.animationFrameId=requestAnimationFrame(this.animate)}}const v=document.querySelector("#app");if(!v)throw new Error("App container missing");v.innerHTML=`
  <div class="maze-shell">
    <canvas id="gameCanvas"></canvas>
    <div class="maze-overlay" data-visible="false">
      <div class="maze-overlay-card">
        <p class="maze-overlay-title">Escaped</p>
        <button id="overlayRestart" type="button">New Maze</button>
      </div>
    </div>
  </div>
`;const y=document.querySelector("#gameCanvas"),m=document.querySelector(".maze-overlay"),M=document.querySelector("#overlayRestart");if(!y||!m||!M)throw new Error("Required DOM elements missing");const g=new C(y,{onStateChange(d){m.dataset.visible=d==="escaped"?"true":"false"}}),b=()=>{const d=window.innerWidth,t=window.innerHeight;y.style.width=`${d}px`,y.style.height=`${t}px`,y.style.position="absolute",y.style.left="0px",y.style.top="0px",g.resize(d,t)};b();window.addEventListener("resize",b);M.addEventListener("click",()=>{m.dataset.visible="false",g.reset()});window.addEventListener("keydown",d=>{const i={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",w:"up",W:"up",s:"down",S:"down",a:"left",A:"left",d:"right",D:"right"}[d.key];i&&(d.preventDefault(),g.move(i))});
